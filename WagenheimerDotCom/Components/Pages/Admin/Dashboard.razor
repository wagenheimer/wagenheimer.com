@page "/admin/dashboard"
@layout WagenheimerDotCom.Components.Layout.AdminLayout
@rendermode InteractiveServer
@attribute [Authorize]
@inject WagenheimerDotCom.Services.IBlogService BlogService
@inject NavigationManager NavManager

<PageTitle>Dashboard - Admin</PageTitle>

<div class="flex items-center justify-between mb-8">
    <h1 class="text-3xl font-bold text-white">Dashboard</h1>
    <a href="/admin/posts/new" class="bg-blue-600 hover:bg-blue-500 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition">
        <i data-lucide="plus" class="w-4 h-4"></i>
        <span>New Post</span>
    </a>
</div>

<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <h3 class="text-slate-400 text-sm font-semibold uppercase mb-2">Total Posts</h3>
        <p class="text-3xl font-bold text-white">@posts.Count()</p>
    </div>
    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <h3 class="text-slate-400 text-sm font-semibold uppercase mb-2">Views (All Time)</h3>
        <p class="text-3xl font-bold text-white">--</p>
    </div>
    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
        <h3 class="text-slate-400 text-sm font-semibold uppercase mb-2">System Status</h3>
        <p class="text-3xl font-bold text-emerald-400">Online</p>
    </div>
</div>

<div class="bg-slate-800 rounded-xl border border-slate-700 overflow-hidden">
    <div class="px-6 py-4 border-b border-slate-700 flex justify-between items-center">
        <h2 class="text-white font-bold">Recent Posts</h2>
    </div>

    <div class="overflow-x-auto">
        <table class="w-full text-left">
            <thead class="bg-slate-700/50 text-slate-400 text-xs uppercase">
                <tr>
                    <th class="px-6 py-3">Title</th>
                    <th class="px-6 py-3">Date</th>
                    <th class="px-6 py-3">Tags</th>
                    <th class="px-6 py-3 text-right">Actions</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-slate-700">
                @foreach (var post in posts)
                {
                    <tr class="hover:bg-slate-700/30 transition">
                        <td class="px-6 py-4 font-medium text-white">@post.Title</td>
                        <td class="px-6 py-4 text-slate-400">@post.Date.ToShortDateString()</td>
                        <td class="px-6 py-4">
                            <div class="flex gap-1 flex-wrap">
                                @foreach (var tag in post.Tags ?? Array.Empty<string>())
                                {
                                    <span class="px-2 py-0.5 bg-slate-700 rounded text-xs text-slate-300">@tag</span>
                                }
                            </div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            <div class="flex items-center justify-end gap-2">
                                <a href="/admin/posts/edit/@post.Slug" class="p-2 text-blue-400 hover:bg-blue-500/10 rounded transition" title="Edit">
                                    <i data-lucide="edit-2" class="w-4 h-4"></i>
                                </a>
                                <button @onclick="() => DeletePost(post.Slug)" class="p-2 text-red-400 hover:bg-red-500/10 rounded transition" title="Delete">
                                    <i data-lucide="trash-2" class="w-4 h-4"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
</div>

@code {
    private IEnumerable<BlogPost> posts = Array.Empty<BlogPost>();

    protected override async Task OnInitializedAsync()
    {
        posts = await BlogService.GetPostsAsync();
    }

    private async Task DeletePost(string slug)
    {
        if (await DisplayConfirm("Are you sure?"))
        {
            // Note: Since IBlogService doesn't have Delete yet (we added it in step 798 but need to cast or fix interface injection if it wasn't refreshed),
            // waiting for compiled interface update.
            // Casting to implementation for safety if DI interface hasn't caught up in tooling cache, but code logic is there.
            if (BlogService is WagenheimerDotCom.Services.MarkdownBlogService svc)
            {
                await svc.DeletePostAsync(slug);
            }
            // Or if interface was updated successfully:
            // await BlogService.DeletePostAsync(slug);
            
            posts = await BlogService.GetPostsAsync();
        }
    }

    private Task<bool> DisplayConfirm(string message)
    {
        return Task.FromResult(true); // Simplified for MVP. Real app requires JSInterop confirm.
    }
}
