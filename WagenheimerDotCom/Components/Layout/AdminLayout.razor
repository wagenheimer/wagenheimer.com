@using Microsoft.AspNetCore.Components.Authorization
@inherits LayoutComponentBase
@inject NavigationManager NavigationManager
@inject AuthenticationStateProvider AuthenticationStateProvider

<AuthorizeView>
    <Authorized>
        <div class="min-h-screen bg-slate-900 text-slate-200 font-sans flex">
            <!-- Sidebar -->
            <aside class="w-64 bg-slate-800 border-r border-slate-700 flex flex-col fixed h-full z-20">
                <div class="h-16 flex items-center px-6 border-b border-slate-700">
                    <span class="text-xl font-bold bg-gradient-to-r from-blue-400 to-sky-400 bg-clip-text text-transparent">CEZAR.DEV</span>
                    <span class="ml-2 text-xs bg-slate-700 px-1.5 py-0.5 rounded text-slate-400">ADMIN</span>
                </div>

                <nav class="flex-1 p-4 space-y-1">
                    <NavLink href="/admin/dashboard" Match="NavLinkMatch.All" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition" ActiveClass="bg-slate-700 text-white">
                        <i data-lucide="layout-dashboard" class="w-5 h-5"></i>
                        <span>Dashboard</span>
                    </NavLink>
                    
                    <div class="pt-4 pb-2 px-4 text-xs font-semibold text-slate-500 uppercase tracking-wider">Content</div>
                    
                    <NavLink href="/admin/posts/new" Match="NavLinkMatch.Prefix" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition" ActiveClass="bg-slate-700 text-white">
                        <i data-lucide="file-plus" class="w-5 h-5"></i>
                        <span>New Post</span>
                    </NavLink>
                    
                    <NavLink href="/admin/games" Match="NavLinkMatch.Prefix" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition" ActiveClass="bg-slate-700 text-white">
                        <i data-lucide="gamepad-2" class="w-5 h-5"></i>
                        <span>Games</span>
                    </NavLink>
                    
                    <a href="/" target="_blank" class="flex items-center gap-3 px-4 py-3 rounded-lg text-slate-400 hover:text-white hover:bg-slate-700 transition mt-8">
                        <i data-lucide="external-link" class="w-5 h-5"></i>
                        <span>View Site</span>
                    </a>
                </nav>

                <div class="p-4 border-t border-slate-700">
                    <form action="api/auth/logout" method="post">
                        <button type="submit" class="flex items-center gap-3 w-full px-4 py-3 rounded-lg text-red-400 hover:bg-red-500/10 transition">
                            <i data-lucide="log-out" class="w-5 h-5"></i>
                            <span>Logout</span>
                        </button>
                    </form>
                </div>
            </aside>

            <!-- Main Content -->
            <main class="flex-1 ml-64 p-8">
                @Body
            </main>
        </div>
    </Authorized>
    <NotAuthorized>
        <div class="min-h-screen bg-slate-950 flex items-center justify-center p-4">
             <div class="text-center">
                 <h2 class="text-white text-xl font-bold mb-2">Access Denied</h2>
                 <p class="text-slate-400 mb-6">You need to log in to access this area.</p>
                 <a href="/admin/login" class="px-6 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition">Go to Login</a>
             </div>
        </div>
    </NotAuthorized>
</AuthorizeView>

<script>
    if (typeof lucide !== 'undefined') {
        lucide.createIcons();
    }
</script>

@code {
    private bool IsActive(string href) => NavigationManager.Uri.EndsWith(href, StringComparison.OrdinalIgnoreCase);

    private async Task Logout()
    {
        // Call the API endpoint to logout (clear cookie)
        // Since we are in Blazor Server/Interactive, we can't easily clear HTTP cookies directly.
        // We'll redirect to a client-side fetch or just use NavigationManager to a controller endpoint if possible,
        // but simple fetch is cleaner for API style.
        
        using var client = new HttpClient { BaseAddress = new Uri(NavigationManager.BaseUri) };
        await client.PostAsync("api/auth/logout", null);
        NavigationManager.NavigateTo("/admin/login", true);
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            // Re-init icons when layout renders
            await InvokeAsync(StateHasChanged);
        }
    }
}
